name: CI/CD Pipeline

# ðŸŽ¯ CuÃ¡ndo se ejecuta este workflow
on:
  push:
    branches: [ master ]      # Cuando haces push a master
  pull_request:
    branches: [ master ]      # Cuando abres un Pull Request a master

# ðŸ”§ Jobs que se ejecutan
jobs:
  # ========================================
  # JOB 1: Build y Test
  # ========================================
  build-and-test:
    name: Build y Tests
    runs-on: ubuntu-latest  # MÃ¡quina virtual Ubuntu
    
    steps:
    # Paso 1: Descargar el cÃ³digo del repositorio
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    # Paso 2: Instalar Node.js
    - name: ðŸŸ¢ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'  # Cachea node_modules para acelerar
    
    # Paso 3: Instalar dependencias
    - name: ðŸ“¦ Instalar dependencias
      run: npm ci
    
    # Paso 4: Ejecutar tests
    - name: ðŸ§ª Ejecutar tests
      run: npm test
      env:
        # Por ahora sin API key real (los tests usan mocks)
        WEATHER_API_KEY: test_key_for_ci
    
    # Paso 5: Subir reporte de cobertura
    - name: ðŸ“Š Subir cobertura
      uses: codecov/codecov-action@v3
      if: always()  # Ejecutar incluso si los tests fallan
      with:
        files: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # ========================================
  # JOB 2: Linting (Opcional pero recomendado)
  # ========================================
  lint:
    name: Verificar CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸŸ¢ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ðŸ“¦ Instalar dependencias
      run: npm ci
    
    # Verificar formato de cÃ³digo (lo agregaremos despuÃ©s)
    - name: ðŸŽ¨ Verificar formato
      run: echo "âœ… VerificaciÃ³n de formato (pendiente configurar ESLint)"
      # DespuÃ©s lo cambiaremos por: npm run lint