name: CI/CD Pipeline

# ğŸ¯ CuÃ¡ndo se ejecuta este workflow
on:
  push:
    branches: [ master ]      # Cuando haces push a master
  pull_request:
    branches: [ master ]      # Cuando abres un Pull Request a master

# ğŸ”§ Jobs que se ejecutan
jobs:
  # ========================================
  # JOB 1: Build y Test
  # ========================================
  build-and-test:
    name: Build y Tests
    runs-on: ubuntu-latest  # MÃ¡quina virtual Ubuntu
    
    steps:
    # Paso 1: Descargar el cÃ³digo del repositorio
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    # Paso 2: Instalar Node.js
    - name: ğŸŸ¢ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'  # Cachea node_modules para acelerar
    
    # Paso 3: Instalar dependencias
    - name: ğŸ“¦ Instalar dependencias
      run: npm ci

    # Paso 3.5: Verificar que los secrets estÃ¡n configurados
    - name: ğŸ” Verificar secrets
      run: node scripts/check-secrets.js
      env:
        WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
    
    # Paso 4: Ejecutar tests
    - name: ğŸ§ª Ejecutar tests
      run: npm test
      env:
        # Por ahora sin API key real (los tests usan mocks)
        WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
    
    # Paso 5: Subir reporte de cobertura
    - name: ğŸ“Š Subir cobertura
      uses: codecov/codecov-action@v3
      if: always()  # Ejecutar incluso si los tests fallan
      with:
        files: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # ========================================
  # JOB 2: Linting (Opcional pero recomendado)
  # ========================================
  lint:
    name: Verificar CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ Instalar dependencias
      run: npm ci
    
    # Verificar formato de cÃ³digo (lo agregaremos despuÃ©s)
    - name: ğŸ¨ Verificar formato
      run: echo "âœ… VerificaciÃ³n de formato (pendiente configurar ESLint)"
      # DespuÃ©s lo cambiaremos por: npm run lint

# ========================================
  # JOB 3: Deploy a Render
  # ========================================
  deploy:
    name: Deploy a ProducciÃ³n
    needs: [build-and-test, lint]  # Solo despliega si los tests pasan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
    - name: ğŸš€ Trigger Deploy en Render
      run: |
        echo "âœ… Tests pasaron - Render desplegarÃ¡ automÃ¡ticamente"
        echo "ğŸ”— URL: https://cicd-seguro-tp.onrender.com"
        echo "ğŸ“ Render detecta el push a master y despliega automÃ¡ticamente"
    
    # Opcional: Notificar que el deploy fue exitoso
    - name: ğŸ“¢ Deploy notification
      run: |
        echo "ğŸ‰ AplicaciÃ³n desplegada exitosamente"
        echo "Timestamp: $(date)"